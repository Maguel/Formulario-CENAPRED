---
/* src/components/EvaluacionDanos.astro */
/* Matriz de evaluación de daños estructurales con mediciones */
/* Desktop fijo + responsive fluido sin overflow en móvil */

interface Props {
  class?: string;
  readonly?: boolean;
}

const { class: className, readonly = false } = Astro.props;

// Tipos de daño para la matriz
const damageTypes = [
  "Colapso",
  "Grietas cortante",
  "Grietas flexión",
  "Aplastamiento",
  "Pandeo barras",
  "Pandeo placas",
  "Falla soldadura",
] as const;

const structuralElements = [
  "Columnas",
  "Trabes",
  "Muro Concreto",
  "Mampost.",
] as const;

// Otros daños (con hint opcional tipado correctamente)
const otherDamages: ReadonlyArray<{
  readonly id: string;
  readonly label: string;
  readonly hint?: string;
}> = [
  { id: "vidrios", label: "Vidrios" },
  { id: "acabados", label: "Acabados" },
  { id: "plafones", label: "Plafones" },
  { id: "fachadas", label: "Fachadas" },
  { id: "bardas", label: "Bardas y pretiles" },
  { id: "cubos", label: "Cubos", hint: "(escalera/elevador)" },
  { id: "instalaciones", label: "Instalaciones" },
];
---

<section class={`panel ${className ?? ""}`} data-readonly={readonly}>
  <header class="panel__header">
    <h2>EVALUACIÓN DE DAÑOS</h2>
  </header>

  <div class="layout">
    <!-- IZQUIERDA -->
    <aside class="section section--left">
      <div class="group">
        <h3>Geotécnicos:</h3>
        <div class="checks-vertical">
          <label class="chk">
            <input
              type="checkbox"
              name="geotecnico"
              value="grietas"
              disabled={readonly}
            />
            <span>Grietas en el terreno</span>
          </label>
          <label class="chk">
            <input
              type="checkbox"
              name="geotecnico"
              value="hundimientos"
              disabled={readonly}
            />
            <span>Hundimientos</span>
          </label>

          <div class="field-composite">
            <label class="chk">
              <input
                type="checkbox"
                name="geotecnico"
                value="inclinacion"
                disabled={readonly}
              />
              <span>Inclinación del edificio:</span>
            </label>
            <div class="input-unit">
              <input
                class="line-mini"
                type="text"
                inputmode="decimal"
                placeholder="0.0"
                aria-label="Porcentaje de inclinación"
                disabled={readonly}
              />
              <span class="unit">%</span>
            </div>
          </div>
        </div>
      </div>

      <div class="group">
        <h3>Losas:</h3>
        <div class="checks-vertical">
          <label class="chk">
            <input
              type="checkbox"
              name="losas"
              value="colapso"
              disabled={readonly}
            />
            <span>Colapso</span>
          </label>

          <div class="field-composite">
            <label class="chk">
              <input
                type="checkbox"
                name="losas"
                value="grietas"
                disabled={readonly}
              />
              <span>Grietas máx:</span>
            </label>
            <div class="input-unit">
              <input
                class="line-mini"
                type="text"
                inputmode="decimal"
                placeholder="0.0"
                aria-label="Ancho máximo de grieta"
                disabled={readonly}
              />
              <span class="unit">mm</span>
            </div>
          </div>

          <div class="field-composite">
            <label class="chk">
              <input
                type="checkbox"
                name="losas"
                value="flecha"
                disabled={readonly}
              />
              <span>Flecha máx:</span>
            </label>
            <div class="input-unit">
              <input
                class="line-mini"
                type="text"
                inputmode="decimal"
                placeholder="0.0"
                aria-label="Flecha máxima"
                disabled={readonly}
              />
              <span class="unit">cm</span>
            </div>
          </div>
        </div>
      </div>

      <div class="group">
        <div class="field-inline">
          <span class="lbl">Conexiones:</span>
          <label class="chk chk--inline">
            <input
              type="checkbox"
              name="conexiones"
              value="falla"
              disabled={readonly}
            />
            <span>Falla</span>
          </label>
        </div>
      </div>
    </aside>

    <!-- CENTRO -->
    <section class="section section--center">
      <div
        class="damage-matrix"
        role="grid"
        aria-label="Matriz de evaluación de daños"
      >
        <div class="matrix-header">
          <div class="corner-cell"></div>
          {
            damageTypes.map((type) => (
              <div class="header-cell" role="columnheader">
                <span class="vertical-text">{type}</span>
              </div>
            ))
          }
        </div>

        {
          structuralElements.map((element, rowIndex) => (
            <div class="matrix-row" role="row">
              <div class="row-header" role="rowheader">
                {element}
              </div>
              {damageTypes.map((type, colIndex) => (
                <div class="matrix-cell" role="gridcell">
                  <label class="chk-cell">
                    <input
                      type="checkbox"
                      name={`damage-${rowIndex}-${colIndex}`}
                      aria-label={`${element} - ${type}`}
                      disabled={readonly}
                    />
                    <span class="sr-only">
                      {element} - {type}
                    </span>
                  </label>
                </div>
              ))}
            </div>
          ))
        }
      </div>

      <div class="measurements">
        <h4 class="measurements__title">Mediciones:</h4>

        <!-- Grietas -->
        <div class="measurement-section">
          <div class="measurement-group">
            <span class="measurement-main-label"
              >Ancho máximo de grieta (mm):</span
            >
            <div class="measurement-items">
              <div class="measurement-item">
                <label for="grieta-columnas">Columnas:</label>
                <input
                  id="grieta-columnas"
                  class="line-measurement"
                  type="text"
                  inputmode="decimal"
                  placeholder="0.0"
                  disabled={readonly}
                />
              </div>
              <div class="measurement-item">
                <label for="grieta-trabes">Trabes:</label>
                <input
                  id="grieta-trabes"
                  class="line-measurement"
                  type="text"
                  inputmode="decimal"
                  placeholder="0.0"
                  disabled={readonly}
                />
              </div>
              <div class="measurement-item">
                <label for="grieta-muro-concreto">Muro Concreto:</label>
                <input
                  id="grieta-muro-concreto"
                  class="line-measurement"
                  type="text"
                  inputmode="decimal"
                  placeholder="0.0"
                  disabled={readonly}
                />
              </div>
              <div class="measurement-item">
                <label for="grieta-mampost">Mampost.:</label>
                <input
                  id="grieta-mampost"
                  class="line-measurement"
                  type="text"
                  inputmode="decimal"
                  placeholder="0.0"
                  disabled={readonly}
                />
              </div>
            </div>
          </div>
        </div>

        <!-- Estribos -->
        <div class="measurement-section">
          <div class="measurement-group">
            <span class="measurement-main-label"
              >Separación de estribos (cm):</span
            >
            <div class="measurement-items">
              <div class="measurement-item">
                <label for="estribos-columnas">Columnas:</label>
                <input
                  id="estribos-columnas"
                  class="line-measurement"
                  type="text"
                  inputmode="decimal"
                  placeholder="0.0"
                  disabled={readonly}
                />
              </div>
              <div class="measurement-item">
                <label for="estribos-trabes">Trabes:</label>
                <input
                  id="estribos-trabes"
                  class="line-measurement"
                  type="text"
                  inputmode="decimal"
                  placeholder="0.0"
                  disabled={readonly}
                />
              </div>
              <div class="measurement-item">
                <label for="estribos-muro-concreto">Muro Concreto:</label>
                <input
                  id="estribos-muro-concreto"
                  class="line-measurement"
                  type="text"
                  inputmode="decimal"
                  placeholder="0.0"
                  disabled={readonly}
                />
              </div>
              <div class="measurement-item">
                <label for="estribos-mampost">Mampost.:</label>
                <input
                  id="estribos-mampost"
                  class="line-measurement"
                  type="text"
                  inputmode="decimal"
                  placeholder="0.0"
                  disabled={readonly}
                />
              </div>
            </div>
          </div>
        </div>

        <!-- Sección / espesor -->
        <div class="measurement-section">
          <div class="measurement-group">
            <span class="measurement-main-label"
              >Sección o espesor de muro (cm):</span
            >
            <div class="measurement-items">
              <div class="measurement-item">
                <label for="seccion-columnas">Columnas:</label>
                <input
                  id="seccion-columnas"
                  class="line-measurement"
                  type="text"
                  inputmode="decimal"
                  placeholder="0.0"
                  disabled={readonly}
                />
              </div>
              <div class="measurement-item">
                <label for="seccion-trabes">Trabes:</label>
                <input
                  id="seccion-trabes"
                  class="line-measurement"
                  type="text"
                  inputmode="decimal"
                  placeholder="0.0"
                  disabled={readonly}
                />
              </div>
              <div class="measurement-item measurement-item--composite">
                <label for="seccion-muro-concreto">Muro Concreto:</label>
                <div class="measurement-composite">
                  <input
                    id="seccion-muro-concreto"
                    class="line-measurement"
                    type="text"
                    inputmode="decimal"
                    placeholder="0.0"
                    disabled={readonly}
                  />
                  <span class="t-label">t=</span>
                  <input
                    class="line-measurement line--tiny"
                    type="text"
                    inputmode="decimal"
                    placeholder="0"
                    disabled={readonly}
                  />
                </div>
              </div>
              <div class="measurement-item measurement-item--composite">
                <label for="seccion-mampost">Mampost.:</label>
                <div class="measurement-composite">
                  <input
                    id="seccion-mampost"
                    class="line-measurement"
                    type="text"
                    inputmode="decimal"
                    placeholder="0.0"
                    disabled={readonly}
                  />
                  <span class="t-label">t=</span>
                  <input
                    class="line-measurement line--tiny"
                    type="text"
                    inputmode="decimal"
                    placeholder="0"
                    disabled={readonly}
                  />
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- DERECHA -->
    <aside class="section section--right">
      <div class="box">
        <h3>Entrepiso crítico (más débil y/o más dañado):</h3>
        <div class="field-row">
          <label class="field-label"
            >No. de columnas (o muros) daño severo =</label
          >
          <input
            class="line"
            type="text"
            inputmode="numeric"
            placeholder="0"
            aria-describedby="hint-severo"
            disabled={readonly}
          />
        </div>
        <small id="hint-severo" class="hint"
          >(colapso, aplastamiento, pandeo, grietas &gt; 3 mm)</small
        >
        <div class="field-row">
          <label class="field-label"
            >Total de columnas (muros) en el entrepiso =</label
          >
          <input
            class="line"
            type="text"
            inputmode="numeric"
            placeholder="0"
            disabled={readonly}
          />
        </div>
      </div>

      <div class="box">
        <h3>NIVEL DE DAÑO DE LA ESTRUCTURA</h3>
        <div class="damage-levels">
          <label class="chk"
            ><input
              type="checkbox"
              name="nivel-dano"
              value="colapso-total"
              disabled={readonly}
            /><span>Colapso total</span></label
          >
          <label class="chk"
            ><input
              type="checkbox"
              name="nivel-dano"
              value="severo"
              disabled={readonly}
            /><span>Daño severo</span></label
          >
          <label class="chk"
            ><input
              type="checkbox"
              name="nivel-dano"
              value="medio"
              disabled={readonly}
            /><span>Daño medio</span></label
          >
          <label class="chk"
            ><input
              type="checkbox"
              name="nivel-dano"
              value="ligero"
              disabled={readonly}
            /><span>Daño ligero</span></label
          >
        </div>
      </div>
    </aside>
  </div>

  <!-- OTROS DAÑOS -->
  <footer class="other-damages">
    <span class="lbl">Otros daños:</span>
    <div class="damages-grid">
      {
        otherDamages.map((damage) => (
          <label class="chk chk--inline">
            <input
              type="checkbox"
              name="otros-danos"
              value={damage.id}
              disabled={readonly}
            />
            <span>
              {damage.label}
              {damage.hint && <i class="hint-inline">{damage.hint}</i>}
            </span>
          </label>
        ))
      }
    </div>
  </footer>
</section>

<style>
  /* ===== Variables ===== */
  :root {
    --color-primary: #00b7c7;
    --color-primary-dark: #0aa;
    --color-text: #111;
    --color-text-dark: #0f0f0f;
    --color-text-muted: #39555b;
    --color-text-light: #333;
    --color-bg: #fff;
    --color-bg-page: #f5f5f5;
    --color-bg-light: #f9f9f9;
    --color-border: #000;
    --color-border-light: #ddd;

    --font-family: Arial, Helvetica, sans-serif;
    --font-size-base: 13.5px;
    --font-size-sm: 11.5px;
    --font-size-xs: 11px;

    --border-width: 2px;
    --border-width-thin: 1px;
    --border-width-input: 1.8px;

    --panel-width: min(1060px, 100vw);

    --spacing-xs: 0.25rem;
    --spacing-sm: 0.35rem;
    --spacing-md: 0.5rem;
    --spacing-lg: 0.7rem;
    --spacing-xl: 0.9rem;
    --spacing-2xl: 1.1rem;
    --spacing-3xl: 1.4rem;

    --checkbox-size: 14px;
    --cell-size: clamp(22px, 3.2vw, 30px);
    --header-height: clamp(70px, 11vw, 100px);
    --row-header-width: clamp(92px, 15vw, 130px);
  }

  /* ===== Reset & Base ===== */
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  .sr-only {
    position: absolute !important;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  /* ===== Panel ===== */
  .panel {
    width: var(--panel-width);
    margin: auto;
    border: var(--border-width) solid var(--color-primary);
    background: var(--color-bg);
    font-family: var(--font-family);
    color: var(--color-text);
    font-size: var(--font-size-base);
    border-radius: 4px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  }

  .panel__header {
    background: var(--color-primary);
    color: var(--color-bg);
    padding: var(--spacing-lg) var(--spacing-2xl);
    border-bottom: var(--border-width) solid var(--color-primary-dark);
    text-align: center;
  }
  .panel__header h2 {
    font-size: 15.5px;
    font-weight: 800;
    letter-spacing: 0.2px;
  }

  /* ===== Layout Grid (con áreas) ===== */
  .layout {
    display: grid;
    grid-template-columns: minmax(250px, 320px) 1fr minmax(250px, 340px);
    grid-template-areas: "left center right";
    border-top: var(--border-width) solid var(--color-border);
    min-height: 400px;
  }
  .section {
    padding: var(--spacing-xl) var(--spacing-lg);
  }
  .section--left {
    grid-area: left;
    border-right: var(--border-width) solid var(--color-border);
  }
  .section--center {
    grid-area: center;
    border-right: var(--border-width) solid var(--color-border);
    overflow-x: auto;
    overflow-y: hidden;
  }
  .section--right {
    grid-area: right;
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xl);
  }

  /* ===== Groups & Labels ===== */
  .group {
    margin-bottom: var(--spacing-xl);
  }
  .group:last-child {
    margin-bottom: 0;
  }
  .group h3 {
    margin: 0 0 var(--spacing-md) 0;
    font-weight: 800;
    color: var(--color-text-light);
  }

  /* ===== Checkboxes ===== */
  .chk {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-md);
    cursor: pointer;
    min-height: 24px;
  }
  .chk input[type="checkbox"] {
    appearance: none;
    width: var(--checkbox-size);
    height: var(--checkbox-size);
    border: var(--border-width-input) solid var(--color-text-dark);
    background: var(--color-bg);
    border-radius: 2px;
    transition: all 0.2s ease;
    flex-shrink: 0;
  }
  .chk input[type="checkbox"]:checked {
    background: var(--color-primary);
    box-shadow: inset 0 0 0 2px var(--color-bg);
  }
  .chk input[type="checkbox"]:focus-visible {
    outline: 2px solid var(--color-primary);
    outline-offset: 2px;
  }
  .chk input[type="checkbox"]:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .chk--inline {
    gap: 0.35rem;
  }

  .chk-cell {
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    padding: 4px;
  }
  .chk-cell input {
    width: var(--checkbox-size);
    height: var(--checkbox-size);
    margin: 0;
  }

  .checks-vertical {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
  }

  /* ===== Fields & Inputs ===== */
  .field-composite,
  .field-inline {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    flex-wrap: wrap;
  }
  .field-row {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-lg);
  }
  .field-label {
    font-size: var(--font-size-base);
  }

  .line,
  .line-mini,
  .line-measurement {
    border: none;
    border-bottom: var(--border-width-input) solid var(--color-text-dark);
    background: transparent;
    font-family: inherit;
    color: var(--color-text);
    transition: border-color 0.2s ease;
  }
  .line {
    padding: var(--spacing-sm) var(--spacing-sm);
    min-width: 80px;
  }
  .line-mini {
    width: clamp(70px, 15vw, 90px);
    padding: var(--spacing-xs) var(--spacing-sm);
  }
  .line-measurement {
    padding: var(--spacing-xs) var(--spacing-sm);
    width: 100%;
    max-width: 120px;
  }
  .line:focus,
  .line-mini:focus,
  .line-measurement:focus {
    outline: none;
    border-color: var(--color-primary);
  }
  .line:disabled,
  .line-mini:disabled,
  .line-measurement:disabled {
    opacity: 0.8;
  }

  .line--tiny {
    max-width: 60px;
  }
  .input-unit {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
  }
  .unit,
  .t-label {
    font-weight: 700;
    white-space: nowrap;
  }

  .lbl {
    font-weight: 700;
  }

  /* ===== Matriz de Daños ===== */
  .damage-matrix {
    display: flex;
    flex-direction: column;
    min-width: 100%;
    margin-bottom: var(--spacing-xl);
  }
  .matrix-header {
    display: grid;
    grid-template-columns: var(--row-header-width) repeat(7, var(--cell-size));
    gap: 4px;
    height: var(--header-height);
    padding-bottom: var(--spacing-sm);
  }
  .header-cell {
    display: flex;
    align-items: end;
    justify-content: center;
    padding-bottom: var(--spacing-md);
  }
  .vertical-text {
    writing-mode: vertical-rl;
    transform: rotate(180deg);
    font-weight: 700;
    font-size: clamp(11px, 1.5vw, 13px);
    white-space: nowrap;
    text-align: center;
  }
  .matrix-row {
    display: grid;
    grid-template-columns: var(--row-header-width) repeat(7, var(--cell-size));
    gap: 4px;
    align-items: center;
    min-height: 32px;
    padding: var(--spacing-xs) 0;
  }
  .row-header {
    font-weight: 700;
    font-size: clamp(12px, 1.5vw, 13px);
    padding-right: var(--spacing-md);
    text-align: left;
  }
  .matrix-cell {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 28px;
    background: var(--color-bg-light);
    border: 1px solid var(--color-border-light);
    border-radius: 2px;
  }

  /* ===== Mediciones ===== */
  .measurements {
    margin-top: var(--spacing-2xl);
    padding-top: var(--spacing-xl);
    border-top: var(--border-width-thin) solid var(--color-border-light);
    display: flex;
    flex-direction: column;
    gap: var(--spacing-2xl);
  }
  .measurements__title {
    font-weight: 800;
    color: var(--color-text-light);
    margin-bottom: var(--spacing-lg);
  }
  .measurement-section {
    margin-bottom: var(--spacing-xl);
  }
  .measurement-group {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-lg);
  }
  .measurement-main-label {
    font-weight: 700;
    display: block;
    margin-bottom: var(--spacing-md);
  }
  .measurement-items {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
    gap: var(--spacing-lg) var(--spacing-xl);
    padding-left: var(--spacing-lg);
  }
  .measurement-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    min-width: 0;
  }
  .measurement-item label {
    min-width: 98px;
    flex-shrink: 0;
  }
  .measurement-item--composite {
    grid-column: span 2;
  }
  .measurement-composite {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    flex: 1;
    min-width: 0;
  }

  /* ===== Cajas derecha ===== */
  .box {
    border: var(--border-width) solid var(--color-border);
    padding: var(--spacing-lg);
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
  }
  .box h3 {
    font-size: clamp(12.5px, 1.5vw, 13.5px);
    font-weight: 700;
    color: var(--color-text-light);
    line-height: 1.3;
  }
  .hint {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
  }

  .damage-levels {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--spacing-md);
  }

  /* ===== Otros daños ===== */
  .other-damages {
    display: flex;
    align-items: flex-start;
    gap: var(--spacing-lg);
    padding: var(--spacing-xl);
    border-top: var(--border-width) solid var(--color-border);
  }
  .damages-grid {
    display: grid;
    gap: var(--spacing-sm) var(--spacing-xl);
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    width: 100%;
  }
  .hint-inline {
    font-style: normal;
    color: var(--color-text-muted);
    margin-left: 0.25rem;
    font-size: var(--font-size-sm);
  }

  /* ===== Responsivo ===== */
  @media (max-width: 1100px) {
    :root {
      --row-header-width: clamp(84px, 14vw, 110px);
      --cell-size: clamp(20px, 3.4vw, 28px);
      --header-height: clamp(64px, 10.5vw, 88px);
    }
    .layout {
      grid-template-columns: 1fr 1.4fr 1fr;
    }
  }

  @media (max-width: 980px) {
    .layout {
      grid-template-columns: 1fr;
      grid-template-areas:
        "center"
        "left"
        "right";
    }
    .section--left,
    .section--center {
      border-right: none;
    }
    .section--left {
      border-top: var(--border-width) solid var(--color-border);
    }
    .section--right {
      border-top: var(--border-width) solid var(--color-border);
    }
    .measurement-item--composite {
      grid-column: span 1;
    }
    .measurement-items {
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      padding-left: 0;
    }
  }

  @media (max-width: 620px) {
    :root {
      --font-size-base: 13px;
      --row-header-width: 80px;
      --cell-size: 24px;
      --header-height: 64px;
    }
    .panel {
      border-width: 1.5px;
    }
    .panel__header h2 {
      font-size: 14.5px;
    }
    .measurement-items {
      grid-template-columns: repeat(1, minmax(0, 1fr));
    }
    .box {
      padding: var(--spacing-md);
    }
    .other-damages {
      flex-direction: column;
      gap: var(--spacing-md);
    }
  }

  @media (max-width: 420px) {
    :root {
      --row-header-width: 72px;
      --cell-size: 22px;
      --header-height: 58px;
    }
    .vertical-text {
      font-size: 10.5px;
    }
    .row-header {
      font-size: 11.5px;
    }
    .measurement-item label {
      min-width: 88px;
    }
    .matrix-header {
      height: 5.5rem;
    }
    .panel{
      width: 100vw;
    }
  }
</style>
