---
// src/components/EvaluacionDanos.astro
// Matriz de evaluación de daños — Presentación homogénea (sin lógica de mensajes)
// Estilo coherente con AccionesEncuesta y CroquisInmueble

interface Props {
  class?: string;
  readonly?: boolean;
}

const { class: className, readonly = false } = Astro.props;

// Tipos de daño para la matriz (columnas)
const damageTypes = [
  "Colapso",
  "Grietas cortante",
  "Grietas flexión",
  "Aplastamiento",
  "Pandeo barras",
  "Pandeo placas",
  "Falla soldadura",
] as const;

// Elementos estructurales (filas)
const structuralElements = [
  "Columnas",
  "Trabes",
  "Muro Concreto",
  "Mampost.",
] as const;

// Otros daños con pista opcional
const otherDamages: ReadonlyArray<{
  readonly id: string;
  readonly label: string;
  readonly hint?: string;
}> = [
  { id: "vidrios", label: "Vidrios" },
  { id: "acabados", label: "Acabados" },
  { id: "plafones", label: "Plafones" },
  { id: "fachadas", label: "Fachadas" },
  { id: "bardas", label: "Bardas y pretiles" },
  { id: "cubos", label: "Cubos", hint: "(escalera/elevador)" },
  { id: "instalaciones", label: "Instalaciones" },
];
---

<section class={`panel ${className ?? ""}`} data-readonly={readonly}>
  <header class="panel__header">
    <h2>EVALUACIÓN DE DAÑOS</h2>
  </header>

  <div class="layout">
    <!-- IZQUIERDA: Geotécnicos / Losas / Conexiones -->
    <aside class="section section--left">
      <!-- Geotécnicos -->
      <div class="group">
        <h3>Geotécnicos:</h3>
        <div class="checks-vertical">
          <label class="chk">
            <input
              type="checkbox"
              name="geotecnico"
              value="grietas"
              disabled={readonly}
            />
            <span>Grietas en el terreno</span>
          </label>
          <label class="chk">
            <input
              type="checkbox"
              name="geotecnico"
              value="hundimientos"
              disabled={readonly}
            />
            <span>Hundimientos</span>
          </label>
          <div class="field-composite">
            <label class="chk">
              <input
                type="checkbox"
                name="geotecnico"
                value="inclinacion"
                disabled={readonly}
              />
              <span>Inclinación del edificio:</span>
            </label>
            <div class="input-unit">
              <input
                class="line-mini"
                type="text"
                inputmode="decimal"
                placeholder="0.0"
                aria-label="Porcentaje de inclinación"
                disabled={readonly}
              />
              <span class="unit">%</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Losas -->
      <div class="group">
        <h3>Losas:</h3>
        <div class="checks-vertical">
          <label class="chk">
            <input
              type="checkbox"
              name="losas"
              value="colapso"
              disabled={readonly}
            />
            <span>Colapso</span>
          </label>
          <div class="field-composite">
            <label class="chk">
              <input
                type="checkbox"
                name="losas"
                value="grietas"
                disabled={readonly}
              />
              <span>Grietas máx:</span>
            </label>
            <div class="input-unit">
              <input
                class="line-mini"
                type="text"
                inputmode="decimal"
                placeholder="0.0"
                aria-label="Ancho máximo de grieta"
                disabled={readonly}
              />
              <span class="unit">mm</span>
            </div>
          </div>
          <div class="field-composite">
            <label class="chk">
              <input
                type="checkbox"
                name="losas"
                value="flecha"
                disabled={readonly}
              />
              <span>Flecha máx:</span>
            </label>
            <div class="input-unit">
              <input
                class="line-mini"
                type="text"
                inputmode="decimal"
                placeholder="0.0"
                aria-label="Flecha máxima"
                disabled={readonly}
              />
              <span class="unit">cm</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Conexiones -->
      <div class="group">
        <div class="field-inline">
          <span class="lbl">Conexiones:</span>
          <label class="chk chk--inline">
            <input
              type="checkbox"
              name="conexiones"
              value="falla"
              disabled={readonly}
            />
            <span>Falla</span>
          </label>
        </div>
      </div>
    </aside>

    <!-- CENTRO: Matriz de daños -->
    <section class="section section--center">
      <div
        class="damage-matrix"
        role="grid"
        aria-label="Matriz de evaluación de daños"
      >
        <!-- Encabezados de columna (tipos de daño) -->
        <div class="matrix-header">
          <div class="corner-cell"></div>
          {
            damageTypes.map((type) => (
              <div class="header-cell" role="columnheader">
                <span class="vertical-text">{type}</span>
              </div>
            ))
          }
        </div>

        <!-- Filas de la matriz -->
        {
          structuralElements.map((element, rowIndex) => (
            <div class="matrix-row" role="row">
              <div class="row-header" role="rowheader">
                {element}
              </div>
              {damageTypes.map((type, colIndex) => (
                <div class="matrix-cell" role="gridcell">
                  <label class="chk chk-cell">
                    <input
                      type="checkbox"
                      name={`damage-${rowIndex}-${colIndex}`}
                      aria-label={`${element} - ${type}`}
                      disabled={readonly}
                    />
                    <span class="sr-only">
                      {element} - {type}
                    </span>
                  </label>
                </div>
              ))}
            </div>
          ))
        }

        <!-- Mediciones -->
        <div class="measurements">
          <div class="measurement-row">
            <label class="measurement-label"
              >Ancho máximo<br />de grieta (mm)</label
            >
            <input
              class="line"
              type="text"
              inputmode="decimal"
              placeholder="0.0"
              disabled={readonly}
            />
          </div>
          <div class="measurement-row">
            <label class="measurement-label"
              >Separación de<br />estribos (cm)</label
            >
            <div class="measurement-composite">
              <input
                class="line"
                type="text"
                inputmode="decimal"
                placeholder="0.0"
                disabled={readonly}
              />
              <span class="t-label">t=</span>
              <input
                class="line line--tiny"
                type="text"
                inputmode="decimal"
                placeholder="0"
                disabled={readonly}
              />
            </div>
          </div>
          <div class="measurement-row">
            <label class="measurement-label"
              >Sección o<br />espesor de muro (cm)</label
            >
            <div class="measurement-composite">
              <input
                class="line"
                type="text"
                inputmode="decimal"
                placeholder="0.0"
                disabled={readonly}
              />
              <span class="t-label">t=</span>
              <input
                class="line line--tiny"
                type="text"
                inputmode="decimal"
                placeholder="0"
                disabled={readonly}
              />
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- DERECHA: Entrepiso crítico y Nivel de daño (checklist) -->
    <aside class="section section--right">
      <!-- Entrepiso crítico -->
      <div class="box">
        <h3>Entrepiso crítico (más débil y/o más dañado):</h3>
        <div class="field-row">
          <label class="field-label"
            >No. de columnas (o muros) daño severo =</label
          >
          <input
            class="line"
            type="text"
            inputmode="numeric"
            placeholder="0"
            aria-describedby="hint-severo"
            disabled={readonly}
          />
        </div>
        <small id="hint-severo" class="hint"
          >(colapso, aplastamiento, pandeo, grietas &gt; 3 mm)</small
        >
        <div class="field-row">
          <label class="field-label"
            >Total de columnas (muros) en el entrepiso =</label
          >
          <input
            class="line"
            type="text"
            inputmode="numeric"
            placeholder="0"
            disabled={readonly}
          />
        </div>
      </div>

      <!-- Nivel de daño (ANTES: radios) AHORA: checkboxes -->
      <div class="box">
        <h3>NIVEL DE DAÑO DE LA ESTRUCTURA</h3>
        <div
          class="damage-levels"
          role="group"
          aria-label="Nivel de daño (múltiple)"
        >
          <label class="chk">
            <input
              type="checkbox"
              name="nivel-dano"
              value="colapso-total"
              disabled={readonly}
            />
            <span>Colapso total</span>
          </label>
          <label class="chk">
            <input
              type="checkbox"
              name="nivel-dano"
              value="severo"
              disabled={readonly}
            />
            <span>Daño severo</span>
          </label>
          <label class="chk">
            <input
              type="checkbox"
              name="nivel-dano"
              value="medio"
              disabled={readonly}
            />
            <span>Daño medio</span>
          </label>
          <label class="chk">
            <input
              type="checkbox"
              name="nivel-dano"
              value="ligero"
              disabled={readonly}
            />
            <span>Daño ligero</span>
          </label>
        </div>
      </div>
    </aside>
  </div>

  <!-- OTROS DAÑOS -->
  <footer class="other-damages">
    <span class="lbl">Otros daños:</span>
    <div class="damages-grid">
      {
        otherDamages.map((damage) => (
          <label class="chk chk--inline">
            <input
              type="checkbox"
              name="otros-danos"
              value={damage.id}
              disabled={readonly}
            />
            <span>
              {damage.label}
              {damage.hint && <i class="hint-inline">{damage.hint}</i>}
            </span>
          </label>
        ))
      }
    </div>
  </footer>
</section>

<style>
  /* ===== Variables CSS (alineadas con otros componentes) ===== */
  :root {
    --color-primary: #00b7c7;
    --color-primary-dark: #0aa;
    --color-text: #111;
    --color-text-dark: #0f0f0f;
    --color-text-muted: #39555b;
    --color-text-light: #333;
    --color-bg: #fff;
    --color-border: #000;
    --color-border-light: #eaeaea;

    --font-family: Arial, Helvetica, sans-serif;
    --font-size-base: 13.5px;
    --font-size-sm: 11.5px;

    --border-width: 2px;
    --border-width-thin: 1px;
    --border-width-input: 1.8px;

    --panel-width: min(1060px, calc(100vw - 20px));

    --spacing-xs: 0.15rem;
    --spacing-sm: 0.25rem;
    --spacing-md: 0.45rem;
    --spacing-lg: 0.6rem;
    --spacing-xl: 0.75rem;
    --spacing-2xl: 0.9rem;
    --spacing-3xl: 14px;

    --checkbox-size: 14px;
    --cell-size: clamp(20px, 3vw, 26px);
    --header-height: clamp(70px, 10vw, 90px);
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  /* ===== Panel ===== */
  .panel {
    width: var(--panel-width);
    margin: var(--spacing-3xl) auto;
    border: var(--border-width) solid var(--color-primary);
    background: var(--color-bg);
    font-family: var(--font-family);
    color: var(--color-text);
    font-size: var(--font-size-base);
    border-radius: 4px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .panel__header {
    background: var(--color-primary);
    color: var(--color-bg);
    padding: var(--spacing-lg) var(--spacing-2xl);
    border-bottom: var(--border-width) solid var(--color-primary-dark);
    text-align: center;
  }

  .panel__header h2 {
    margin: 0;
    font-size: 15.5px;
    font-weight: 800;
    letter-spacing: 0.2px;
  }

  /* ===== Layout ===== */
  .layout {
    display: grid;
    grid-template-columns: minmax(250px, 320px) 1fr minmax(250px, 340px);
    border-top: var(--border-width) solid var(--color-border);
    min-height: 400px;
  }

  .section {
    padding: var(--spacing-lg) var(--spacing-2xl);
  }
  .section--left {
    border-right: var(--border-width) solid var(--color-border);
  }
  .section--center {
    border-right: var(--border-width) solid var(--color-border);
    overflow-x: auto;
    overflow-y: hidden;
    padding: var(--spacing-lg);
  }
  .section--right {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xl);
  }

  /* ===== Groups ===== */
  .group {
    margin-bottom: var(--spacing-xl);
  }
  .group:last-child {
    margin-bottom: 0;
  }
  .group h3 {
    margin: 0 0 var(--spacing-md) 0;
    font-size: var(--font-size-base);
    font-weight: 800;
    color: var(--color-text-light);
  }

  /* ===== Checkboxes ===== */
  .chk {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-md);
    cursor: pointer;
    min-height: 24px;
  }
  .chk input[type="checkbox"] {
    appearance: none;
    width: var(--checkbox-size);
    height: var(--checkbox-size);
    border: var(--border-width-input) solid var(--color-text-dark);
    background: var(--color-bg);
    cursor: pointer;
    transition: all 0.2s ease;
    flex-shrink: 0;
    border-radius: 2px;
  }
  .chk input[type="checkbox"]:checked {
    background: var(--color-primary);
    box-shadow: inset 0 0 0 2px var(--color-bg);
  }
  .chk input[type="checkbox"]:focus-visible {
    outline: 2px solid var(--color-primary);
    outline-offset: 2px;
  }
  .chk input[type="checkbox"]:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .chk--inline {
    gap: 0.35rem;
  }
  .chk-cell input {
    width: var(--checkbox-size);
    height: var(--checkbox-size);
    margin: 0;
  }

  .checks-vertical {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
  }

  /* ===== Inputs ===== */
  .line {
    border: none;
    border-bottom: var(--border-width-input) solid var(--color-text-dark);
    background: transparent;
    padding: var(--spacing-sm) var(--spacing-sm);
    font-size: var(--font-size-base);
    font-family: inherit;
    color: var(--color-text);
    transition: border-color 0.2s ease;
    flex: 1;
    min-width: 80px;
  }
  .line:focus {
    outline: none;
    border-color: var(--color-primary);
  }
  .line:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .line-mini {
    width: clamp(70px, 15vw, 90px);
    border: none;
    border-bottom: var(--border-width-input) solid var(--color-text-dark);
    background: transparent;
    padding: var(--spacing-xs) var(--spacing-sm);
    font-size: var(--font-size-base);
    transition: border-color 0.2s ease;
  }
  .line-mini:focus {
    outline: none;
    border-color: var(--color-primary);
  }
  .line--tiny {
    flex: 0 0 clamp(50px, 10vw, 72px);
    min-width: 50px;
  }

  .input-unit {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
  }
  .unit {
    font-size: var(--font-size-base);
    color: var(--color-text);
    flex-shrink: 0;
  }
  .lbl {
    font-weight: 700;
    color: var(--color-text);
  }
  .t-label {
    font-weight: 700;
    white-space: nowrap;
    margin: 0 var(--spacing-sm);
  }

  /* ===== Matriz de daños ===== */
  .damage-matrix {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
    min-width: 100%;
  }
  .matrix-header {
    display: grid;
    grid-template-columns: clamp(80px, 12vw, 120px) repeat(7, var(--cell-size));
    gap: var(--spacing-sm);
    height: var(--header-height);
  }
  .header-cell {
    display: flex;
    align-items: end;
    justify-content: center;
    padding-bottom: var(--spacing-md);
  }
  .vertical-text {
    writing-mode: vertical-rl;
    transform: rotate(180deg);
    font-weight: 700;
    font-size: clamp(11px, 1.5vw, 13px);
    white-space: nowrap;
  }
  .matrix-row {
    display: grid;
    grid-template-columns: clamp(80px, 12vw, 120px) repeat(7, var(--cell-size));
    gap: var(--spacing-sm);
    align-items: center;
  }
  .row-header {
    font-weight: 700;
    font-size: clamp(12px, 1.5vw, 13px);
    padding-right: var(--spacing-md);
  }
  .matrix-cell {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* ===== Mediciones ===== */
  .measurements {
    margin-top: var(--spacing-xl);
    padding-top: var(--spacing-xl);
    border-top: var(--border-width-thin) solid var(--color-border-light);
    display: flex;
    flex-direction: column;
    gap: var(--spacing-lg);
  }
  .measurement-row {
    display: flex;
    align-items: center;
    gap: var(--spacing-lg);
  }
  .measurement-label {
    font-size: clamp(12px, 1.5vw, 13px);
    color: var(--color-text);
    min-width: 120px;
    flex-shrink: 0;
  }
  .measurement-composite {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    flex: 1;
    flex-wrap: wrap;
  }

  /* ===== Cajas derechas ===== */
  .box {
    border: var(--border-width) solid var(--color-border);
    padding: var(--spacing-lg);
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
  }
  .box h3 {
    margin: 0;
    font-size: clamp(12.5px, 1.5vw, 13.5px);
    font-weight: 700;
    color: var(--color-text-light);
    line-height: 1.3;
    hyphens: auto;
  }
  .damage-levels {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
  }

  /* ===== Pistas ===== */
  .hint {
    display: block;
    color: var(--color-text-muted);
    font-size: var(--font-size-sm);
    font-style: italic;
    margin-top: var(--spacing-xs);
  }
  .hint-inline {
    font-style: italic;
    color: var(--color-text-muted);
    font-size: var(--font-size-base);
  }

  /* ===== Otros daños ===== */
  .other-damages {
    border-top: var(--border-width) solid var(--color-border);
    padding: var(--spacing-lg) var(--spacing-2xl);
    display: flex;
    align-items: flex-start;
    gap: var(--spacing-xl);
  }
  .damages-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: var(--spacing-md) var(--spacing-xl);
    flex: 1;
  }

  /* ===== Accesibilidad ===== */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  /* ===== Responsive ===== */
  @media (max-width: 1024px) {
    .layout {
      grid-template-columns: 280px 1fr;
    }
    .section--right {
      grid-column: 1 / -1;
      border-top: var(--border-width) solid var(--color-border);
      flex-direction: row;
      padding-top: var(--spacing-xl);
    }
    .section--center {
      border-right: none;
    }
    .box {
      flex: 1;
    }
  }

  @media (max-width: 768px) {
    :root {
      --cell-size: 22px;
      --header-height: 70px;
    }
    .layout {
      grid-template-columns: 1fr;
    }
    .section--left {
      border-right: none;
      border-bottom: var(--border-width) solid var(--color-border);
    }
    .section--center {
      border-bottom: var(--border-width) solid var(--color-border);
      padding: var(--spacing-md);
    }
    .section--right {
      flex-direction: column;
    }
    .matrix-header,
    .matrix-row {
      grid-template-columns: 75px repeat(7, var(--cell-size));
    }
    .measurements {
      margin-top: var(--spacing-lg);
    }
    .measurement-row {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--spacing-sm);
    }
    .measurement-label {
      min-width: auto;
    }
    .measurement-composite {
      width: 100%;
    }
    .other-damages {
      flex-direction: column;
      gap: var(--spacing-md);
    }
    .damages-grid {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 480px) {
    :root {
      --cell-size: 18px;
      --header-height: 60px;
      --font-size-base: 12.5px;
      --checkbox-size: 12px;
    }
    .panel {
      width: calc(100vw - 10px);
      margin: 8px auto;
    }
    .section {
      padding: var(--spacing-md);
    }
    .vertical-text {
      font-size: 10px;
      padding-bottom: var(--spacing-md);
    }
    .row-header {
      font-size: 11px;
    }
    .field-composite {
      flex-direction: column;
      align-items: flex-start;
    }
    .line-mini {
      width: 100%;
      max-width: 120px;
    }
    .box h3 {
      font-size: 12px;
    }
  }

  @media (max-width: 360px) {
    :root {
      --cell-size: 16px;
    }
    .matrix-header,
    .matrix-row {
      grid-template-columns: 65px repeat(7, var(--cell-size));
      gap: 3px;
    }
    .chk span {
      font-size: 11.5px;
    }
  }
</style>
